language: java
jdk: openjdk8

before_script:
  # Setup biotestmine to test against
  - git clone https://github.com/intermine/docker-intermine-gradle
  - (cd docker-intermine-gradle && docker-compose -f dockerhub.docker-compose.yml up -d)
  # Wait until biotestmine has started
  - until $(curl --output /dev/null --silent --head --fail http://localhost:9999/biotestmine); do sleep 20; done
  # Install lein - required to build the project
  - wget https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein -O /tmp/lein
  - chmod +x /tmp/lein
  - export PATH=$PATH:/tmp/lein
  # make several attempts at downloading dependencies
  - travis_retry lein deps
  # check code is well formatted
  - lein cljfmt check

script:
  - lein doo phantom test once
  # build API docs
  - lein codox
  
# Deploys build API docs:
deploy:
  provider: pages
  skip-cleanup: true
  github-token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
  keep-history: true
  local-dir: target/doc
  on:
    branch: dev
